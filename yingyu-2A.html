<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>听写小程序</title>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f3f6fa;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 430px;
            padding: 32px 18px 42px 18px;
            margin: 38px auto 0 auto;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 2px 14px #c4d3e38c;
        }
        h2 {
            margin: 0 0 16px 0;
            font-weight: 600;
            color: #29487d;
            letter-spacing: 1px;
            font-size: 1.36rem;
            text-align: center;
        }
        .input-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .input-row label {
            flex: 1 0 90px;
        }
        .input-row input[type="number"] {
            width: 70px;
            margin-left: 5px;
            padding: 4px 7px;
            border-radius: 5px;
            border: 1px solid #b8bac4;
        }
        .early-settings-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 14px;
            align-items: center;
        }
        .early-setting {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-row {
            margin-top: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        button {
            background: #3679e0;
            color: #fff;
            font-weight: 500;
            border: none;
            border-radius: 7px;
            padding: 8px 20px;
            font-size: 1.04rem;
            cursor: pointer;
            margin-right: 9px;
            transition: background .18s;
        }
        button:disabled {
            background: #90acd6;
            cursor: not-allowed;
        }
        .status-bar {
            color: #93a1b1;
            font-size: .98rem;
            text-align: center;
            margin-top: 12px;
        }
        .tips {
            margin-top: 13px;
            background: #e7f3fc;
            color: #3872c1;
            border-left: 4px solid #6aa2df;
            padding: 7px 13px;
            border-radius: 5px;
            font-size: .97rem;
        }
        .range-row {
            margin: 14px 0 5px 0;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .range-row label {
            font-size: .98rem;
            margin-right: 2px;
        }
        .range-select {
            padding: 3px;
            border-radius: 5px;
            border: 1px solid #b8bac4;
            font-size: 1rem;
        }
        #wordsPreview {
            margin: 15px 0 10px 0;
            padding: 10px;
            background: #f4f7fa;
            color: #285285;
            border-radius: 6px;
            font-size: 1.11rem;
            min-height: 32px;
            line-height: 2;
            word-break: break-all;
            text-align: left;
            letter-spacing: 2px;
            transition: opacity 0.3s;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            /* 支持超出自动换行，统一缩进、视觉左齐 */
            white-space: normal;  /* 关键：允许换行 */
            overflow-wrap: anywhere; /* 关键：强制单词内换行以防溢出 */
            /* 新增：当词太多时出现下拉条 */
            max-height: 208px;
            overflow-y: auto;
        }
        #wordsPreview.hide {
            opacity: 0;
            pointer-events: none;
            height: 0;
            overflow: hidden;
            padding: 0;
            margin: 0;
        }
        .preview-lesson-title {
            font-weight:bold;
            font-size:1.08em;
            color:#397bbe;
            margin-bottom:3px;
        }
        .preview-lesson-words {
            display: flex;
            flex-wrap: wrap;
            line-height:2.1;
            font-size:1.08em;
            gap:0 22px;
            margin-bottom: 7px;
        }
        .pinyin-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 0.5em;
            margin-right: 0;
            margin-bottom: 6px;
        }
        .pinyin-text {
            font-size: 0.92em;
            color: #8495bb;
            line-height: 1.32;
            margin-bottom: 2px;
            user-select: none;
            pointer-events: none;
        }
        .zi-text {
            font-size: 1.08em;
        }
        @media (max-width: 500px) {
            .container {
                margin: 6px;
                padding: 14px 3vw 22px 3vw;
            }
            h2 {
                font-size: 1.02rem;
            }
            button {
                padding: 6px 4vw;
            }
            .range-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            #wordsPreview {
                font-size: .99rem;
                padding: 7px 2vw;
                max-height: 44vw;
            }
            .early-settings-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 7px;
            }
        }
        #restartBtn {
            background: #45d6a1;
            color: #fff;
            margin-right: 9px;
            border: none;
            border-radius: 7px;
            padding: 8px 20px;
            font-size: 1.04rem;
            font-weight: 500;
            cursor: pointer;
            transition: background .18s;
        }
        #restartBtn:disabled {
            background: #90e6c6;
            cursor: not-allowed;
        }
        .relisten-row {
            margin-top: 25px;
            text-align: center;
        }
        .relisten-row button {
            background: #45d6a1;
            margin: 0 auto;
            display: inline-block;
            box-shadow: 0 1px 3px #9fe5cb4d;
        }
        /* 新增: 隐藏early-setting动态样式 */
        .early-setting.hide {
            display: none !important;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>听写播报</h2>

    <!-- 优先设置区：乱序/顺序、自动/手动、间隔、次数、语速 -->
    <div class="early-settings-row">
        <div class="early-setting" style="width:100%;margin-bottom:6px;">
            <span>顺序：</span>
            <label>
                <input type="radio" name="shuffleOrder" value="order" id="orderRadio" checked> 顺序
            </label>
            <label>
                <input type="radio" name="shuffleOrder" value="shuffle" id="shuffleRadio"> 乱序
            </label>
        </div>
        <div class="early-setting" style="width:100%;margin-bottom:6px;">
            <span>播放：</span>
            <label>
                <input type="radio" name="autoPlayType" value="manual" id="manualRadio" checked> 手动
            </label>
            <label>
                <input type="radio" name="autoPlayType" value="auto" id="autoRadio"> 自动
            </label>
        </div>
        <div class="early-setting" style="display:flex;gap:16px;width:100%;">
            <div id="intervalSetting" style="display:flex;align-items:center;">
                <label for="intervalEarly" style="margin-bottom:0;">间隔(秒):</label>
                <input type="number" id="intervalEarly" value="20" min="1" style="width:60px;margin-left:5px;" disabled>
            </div>
            <div style="display:flex;align-items:center;">
                <label for="repeatCountEarly" style="margin-bottom:0;">每词读次数:</label>
                <input type="number" id="repeatCountEarly" value="2" min="1" max="10" style="width:60px;margin-left:5px;">
            </div>
        </div>
        <div class="early-setting" style="width:100%;">
            <!-- 语速(整数)：只允许整数1-3 -->
            <label for="rateEarly" style="margin-bottom:0;">语速(1-3):</label>
            <input type="number" id="rateEarly" value="1" min="1" max="3" step="1" style="width:60px;margin-left:5px;">
        </div>
    </div>

    <!-- 课文范围选择器 -->
    <div class="range-row">
        <label for="startLesson">课文范围：</label>
        <select id="startLesson" class="range-select"></select>
        <span>—</span>
        <select id="endLesson" class="range-select"></select>
    </div>
    <!-- 词语预览区，初始可见，听写时隐藏 -->
    <div id="wordsPreview"></div>
    <!-- 词语编辑和展示已移除。仅保留textarea用于存储和自定义编辑（隐藏） -->
    <textarea id="words" style="display:none;"></textarea>
    <!-- 保留原本的控制按钮，不再单独展示原复选框和参数输入 -->
    <div class="btn-row">
        <button id="startBtn">开始</button>
        <button id="prevBtn" disabled>上一个</button>
        <button id="nextBtn" disabled>下一个</button>
        <button id="pauseContinueBtn" disabled>暂停</button>
        <button id="resetBtn" style="display:none;">结束</button>
    </div>
    <div class="status-bar" id="status"></div>
    <!-- 重新开始按钮始终展示，不要隐藏 -->
    <div class="relisten-row" id="relistenRow">
        <button id="restartBtn">重新开始</button>
    </div>
</div>

<script>
// 将 LESSONS 提前到全局，供 getWordPinyin 正常访问
const LESSONS = [
    {
        "name": "阅读1",
        "words": ["妈妈", "身子", "他们", "看见", "我们", "哪里", "那边", "雪白", "过去", "孩子", "什么", "两条", "宽广", "长短", "成长"],
        "pinyin": [["mā", "ma"], ["shēn", "zi"], ["tā", "men"], ["kàn", "jiàn"], ["wǒ", "men"], ["nǎ", "lǐ"], ["nà", "biān"], ["xuě", "bái"], ["guò", "qù"], ["hái", "zi"], ["shén", "me"], ["liǎng", "tiáo"], ["kuān", "guǎng"], ["cháng", "duǎn"], ["chéng", "zhǎng"]]
    },
    {
        "name": "阅读2",
        "words": ["太阳", "天空", "一起", "冬天", "花朵", "池子", "江河", "海洋", "许多", "田地", "工作", "办法", "你们", "上升", "连忙"],
        "pinyin": [["tài", "yáng"], ["tiān", "kōng"], ["yì", "qǐ"], ["dōng", "tiān"], ["huā", "duǒ"], ["chí", "zi"], ["jiāng", "hé"], ["hǎi", "yáng"], ["xǔ", "duō"], ["tián", "dì"], ["gōng", "zuò"], ["bàn", "fǎ"], ["nǐ", "men"], ["shàng", "shēng"], ["lián", "máng"]]
    },
    {
        "name": "阅读3",
        "words": ["如果", "已经", "长大", "告别", "四海为家", "自己", "出发", "动物", "胆子", "肚子", "那里", "知识", "年轻", "更多"],
        "pinyin": [["rú", "guǒ"], ["yǐ", "jīng"], ["zhǎng", "dà"], ["gào", "bié"], ["sì", "hǎi", "wéi", "jiā"], ["zì", "jǐ"], ["chū", "fā"], ["dòng", "wù"], ["dǎn", "zi"], ["dù", "zi"], ["nà", "lǐ"], ["zhī", "shi"], ["nián", "qīng"], ["gèng", "duō"]]
    },
    {
        "name": "识字1",
        "words": ["花园", "飞鸟", "红领巾", "欢笑", "到处", "方块", "群众", "座位", "队长"],
        "pinyin": [["huā", "yuán"], ["fēi", "niǎo"], ["hóng", "lǐng", "jīn"], ["huān", "xiào"], ["dào", "chù"], ["fāng", "kuài"], ["qún", "zhòng"], ["zuò", "wèi"], ["duì", "zhǎng"]]
    },
    {
        "name": "识字2",
        "words": ["杨树", "树叶", "松柏", "化石", "开花", "之后", "金桂"],
        "pinyin": [["yáng", "shù"], ["shù", "yè"], ["sōng", "bǎi"], ["huà", "shí"], ["kāi", "huā"], ["zhī", "hòu"], ["jīn", "guì"]]
    },
    {
        "name": "识字3",
        "words": ["拍手", "世界", "云彩", "丛林", "竹林", "朋友", "保护", "休息"],
        "pinyin": [["pāi", "shǒu"], ["shì", "jiè"], ["yún", "cǎi"], ["cóng", "lín"], ["zhú", "lín"], ["péng", "you"], ["bǎo", "hù"], ["xiū", "xi"]]
    },
    {
        "name": "识字4",
        "words": ["四季", "春风", "农事", "月光", "身体", "辛苦", "心里", "大家", "肥胖", "谷子", "虽说", "初中"],
        "pinyin": [["sì", "jì"], ["chūn", "fēng"], ["nóng", "shì"], ["yuè", "guāng"], ["shēn", "tǐ"], ["xīn", "kǔ"], ["xīn", "lǐ"], ["dà", "jiā"], ["féi", "pàng"], ["gǔ", "zi"], ["suī", "shuō"], ["chū", "zhōng"]]
    },
    {
        "name": "阅读4",
        "words": ["天上", "美丽", "爸爸", "下来", "不用", "高兴", "哥哥", "秋千", "彩云", "提起", "好吗", "团圆", "挂住", "好啊"],
        "pinyin": [["tiān", "shàng"], ["měi", "lì"], ["bà", "ba"], ["xià", "lái"], ["bú", "yòng"], ["gāo", "xìng"], ["gē", "ge"], ["qiū", "qiān"], ["cǎi", "yún"], ["tí", "qǐ"], ["hǎo", "ma"], ["tuán", "yuán"], ["guà", "zhù"], ["hǎo", "a"]]
    },
    {
        "name": "阅读5",
        "words": ["宝贝", "干活", "回来", "一些", "天气", "欢快", "它们", "告诉", "名字", "出门"],
        "pinyin": [["bǎo", "bèi"], ["gàn", "huó"], ["huí", "lái"], ["yī", "xiē"], ["tiān", "qì"], ["huān", "kuài"], ["tā", "men"], ["gào", "su"], ["míng", "zi"], ["chū", "mén"]]
    },
    {
        "name": "阅读6",
        "words": ["星星", "晚上", "无数", "奶奶", "中间", "总是", "爷爷", "北边", "勺子", "转动", "这个", "后来"],
        "pinyin": [["xīng", "xing"], ["wǎn", "shang"], ["wú", "shù"], ["nǎi", "nai"], ["zhōng", "jiān"], ["zǒng", "shì"], ["yé", "ye"], ["běi", "biān"], ["sháo", "zi"], ["zhuǎn", "dòng"], ["zhè", "ge"], ["hòu", "lái"]]
    },
    {
	    "name": "阅读8",
	    "words": ["那些", "山顶", "山头", "云海", "仙人", "前方", "仙女", "巨大", "座位", "闪亮", "小狗", "形状"],
	    "pinyin": [["nà", "xiē"], ["shān", "dǐng"], ["shān", "tóu"], ["yún", "hǎi"], ["xiān", "rén"], ["qián", "fāng"], ["xiān", "nǚ"], ["jù", "dà"], ["zuò", "wèi"], ["shǎn", "liàng"], ["xiǎo", "gǒu"], ["xíng", "zhuàng"]]
    },
    {
        "name": "阅读9",
        "words": ["山区", "群山", "树木", "灯光", "中午", "眼前", "细雨", "风光", "中外", "湖水", "胜利", "海岛", "弯刀", "现在", "就是"],
        "pinyin": [["shān", "qū"], ["qún", "shān"], ["shù", "mù"], ["dēng", "guāng"], ["zhōng", "wǔ"], ["yǎn", "qián"], ["xì", "yǔ"], ["fēng", "guāng"], ["zhōng", "wài"], ["hú", "shuǐ"], ["shèng", "lì"], ["hǎi", "dǎo"], ["wān", "dāo"], ["xiàn", "zài"], ["jiù", "shì"]]
    },
    {
        "name": "阅读10",
        "words": ["地方", "水果", "月份", "枝叶", "五光十色", "好客", "老乡", "有的", "城市", "空气", "水分", "这里", "味道", "有名", "毛孔", "钉子"],
        "pinyin": [["dì", "fang"], ["shuǐ", "guǒ"], ["yuè", "fèn"], ["zhī", "yè"], ["wǔ", "guāng", "shí", "sè"], ["hào", "kè"], ["lǎo", "xiāng"], ["yǒu", "de"], ["chéng", "shì"], ["kōng", "qì"], ["shuǐ", "fèn"], ["zhè", "lǐ"], ["wèi", "dào"], ["yǒu", "míng"], ["máo", "kǒng"], ["dīng", "zi"]]
    },
    {
        "name": "阅读11",
        "words": ["坐井观天", "哪儿", "回答", "大话", "不过", "那么", "抬头"],
        "pinyin": [["zuò", "jǐng", "guān", "tiān"], ["nǎ", "er"], ["huí", "dá"], ["dà", "huà"], ["bú", "guò"], ["nà", "me"], ["tái", "tóu"]]
    },
    {
        "name": "阅读12",
        "words": ["当作", "前面", "面对面", "出去", "过冬", "知道", "赶快", "正好", "明天", "清早", "好像", "一样", "天亮", "出来"],
        "pinyin": [["dàng", "zuò"], ["qián", "miàn"], ["miàn", "duì", "miàn"], ["chū", "qù"], ["guò", "dōng"], ["zhī", "dào"], ["gǎn", "kuài"], ["zhèng", "hǎo"], ["míng", "tiān"], ["qīng", "zǎo"], ["hǎo", "xiàng"], ["yī", "yàng"], ["tiān", "liàng"], ["chū", "lái"]]
    },
    {
        "name": "阅读13",
        "words": ["从前", "以后", "多么", "那个", "叶子", "虫子", "自言自语", "邻居", "奇怪"],
        "pinyin": [["cóng", "qián"], ["yǐ", "hòu"], ["duō", "me"], ["nà", "ge"], ["yè", "zi"], ["chóng", "zi"], ["zì", "yán", "zì", "yǔ"], ["lín", "jū"], ["qí", "guài"]]
    },
    {
        "name": "阅读14",
        "words": ["年代", "更加", "明亮", "星星之火", "中国", "胜利", "道路"],
        "pinyin": [["nián", "dài"], ["gèng", "jiā"], ["míng", "liàng"], ["xīng", "xing", "zhī", "huǒ"], ["zhōng", "guó"], ["shèng", "lì"], ["dào", "lù"]]
    },
    {
        "name": "阅读15",
        "words": ["同志", "红军", "敌人", "生产", "常常", "来回", "非常", "战士", "一块儿", "白天"],
        "pinyin": [["tóng", "zhì"], ["hóng", "jūn"], ["dí", "rén"], ["shēng", "chǎn"], ["cháng", "cháng"], ["lái", "huí"], ["fēi", "cháng"], ["zhàn", "shì"], ["yī", "kuài", "er"], ["bái", "tiān"]]
    },
    {
        "name": "阅读16",
        "words": ["难忘", "火红", "人民", "因为", "总理", "人们", "四面八方", "为了", "人群", "欢乐", "开心"],
        "pinyin": [["nán", "wàng"], ["huǒ", "hóng"], ["rén", "mín"], ["yīn", "wèi"], ["zǒng", "lǐ"], ["rén", "men"], ["sì", "miàn", "bā", "fāng"], ["wèi", "le"], ["rén", "qún"], ["huān", "lè"], ["kāi", "xīn"]]
    },
    {
        "name": "阅读17",
        "words": ["由于", "年轻", "共产党员", "共产党", "现在", "一点儿", "消息"],
        "pinyin": [["yóu", "yú"], ["nián", "qīng"], ["gòng", "chǎn", "dǎng", "yuán"], ["gòng", "chǎn", "dǎng"], ["xiàn", "zài"], ["yī", "diǎn", "er"], ["xiāo", "xi"]]
    },
    {
        "name": "阅读19",
        "words": ["于是", "无论", "船只", "同时", "行人", "一切", "上空", "看来", "不久", "路上", "出现", "散步", "消失"],
        "pinyin": [["yú", "shì"], ["wú", "lùn"], ["chuán", "zhī"], ["tóng", "shí"], ["xíng", "rén"], ["yī", "qiè"], ["shàng", "kōng"], ["kàn", "lái"], ["bù", "jiǔ"], ["lù", "shang"], ["chū", "xiàn"], ["sàn", "bù"], ["xiāo", "shī"]]
    },
    {
        "name": "阅读20",
        "words": ["空地", "伙伴", "唱歌", "回家", "一会儿", "着火", "火星", "一边", "连忙", "树林", "水汽", "白云"],
        "pinyin": [["kòng", "dì"], ["huǒ", "bàn"], ["chàng", "gē"], ["huí", "jiā"], ["yī", "huì", "er"], ["zháo", "huǒ"], ["huǒ", "xīng"], ["yī", "biān"], ["lián", "máng"], ["shù", "lín"], ["shuǐ", "qì"], ["bái", "yún"]]
    },
    {
        "name": "阅读21",
        "words": ["果子", "木工", "身边", "仔细", "能干", "椅子", "怎么", "自信", "从来", "这么"],
        "pinyin": [["guǒ", "zi"], ["mù", "gōng"], ["shēn", "biān"], ["zǐ", "xì"], ["néng", "gàn"], ["yǐ", "zi"], ["zěn", "me"], ["zì", "xìn"], ["cóng", "lái"], ["zhè", "me"]]
    },
    {
        "name": "阅读22",
        "words": ["上面", "快乐", "可是", "难过", "但是", "和好"],
        "pinyin": [["shàng", "miàn"], ["kuài", "lè"], ["kě", "shì"], ["nán", "guò"], ["dàn", "shì"], ["hé", "hǎo"]]
    },
    {
        "name": "阅读23",
        "words": ["眼泪", "水花", "青草", "游戏", "只有", "可爱", "可以", "多少", "咱们", "田野", "大地", "远方"],
        "pinyin": [["yǎn", "lèi"], ["shuǐ", "huā"], ["qīng", "cǎo"], ["yóu", "xì"], ["zhǐ", "yǒu"], ["kě", "ài"], ["kě", "yǐ"], ["duō", "shǎo"], ["zán", "men"], ["tián", "yě"], ["dà", "dì"], ["yuǎn", "fāng"]]
    }
];
// 从数据列表获取拼音
function getWordPinyin(word) {
    // 遍历所有课文找到对应的词语
    for (let lesson of LESSONS) {
        for (let i = 0; i < lesson.words.length; i++) {
            if (lesson.words[i] === word && lesson.pinyin && lesson.pinyin[i]) {
                return lesson.pinyin[i];
            }
        }
    }
    // 如果找不到拼音，返回空数组
    return [];
}
(function() {
    // LESSONS 已在外部声明
    // ... 下方所有原 js 逻辑不变 ...
    // DOM
    const wordsInput = document.getElementById('words');
    const shuffleRadio = document.getElementById('shuffleRadio');
    const orderRadio = document.getElementById('orderRadio');
    const autoRadio = document.getElementById('autoRadio');
    const manualRadio = document.getElementById('manualRadio');
    const intervalEarly = document.getElementById('intervalEarly');
    const repeatCountEarly = document.getElementById('repeatCountEarly');
    const rateEarly = document.getElementById('rateEarly');
    const intervalSetting = document.getElementById('intervalSetting');

    let shuffleCb = { checked: false };
    let autoNextCb = { checked: false };
    let intervalInput = { value: intervalEarly.value, disabled: intervalEarly.disabled };
    let repeatCountInput = { value: repeatCountEarly.value };
    let rateInput = { value: rateEarly.value };

    const startBtn = document.getElementById('startBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pauseContinueBtn = document.getElementById('pauseContinueBtn');
    const resetBtn = document.getElementById('resetBtn');
    const restartBtn = document.getElementById('restartBtn');
    const statusDiv = document.getElementById('status');
    const startLessonSel = document.getElementById('startLesson');
    const endLessonSel = document.getElementById('endLesson');
    const wordsPreview = document.getElementById('wordsPreview');
    const relistenRow = document.getElementById('relistenRow');

    let words = [];
    let currentIndex = 0;
    let playing = false;
    let paused = false;
    let timer = null;
    let orderedList = [];
    let speechSynthesis = window.speechSynthesis;
    let speaking = false;
    let currentRepeat = 1;
    let stopped = false;
    let lastWordsArr = [];
    let lastOrderedList = [];
    let lastShuffleChecked = false;
    let lastAutoNextChecked = false;
    let lastIntervalValue = 4;
    let lastRepeatCount = 1;
    let lastRate = 1;

    // ===== 补充下面变量和辅助函数，实现顺序播放时每课首词前朗读课名 =====
    let wordToLessonNameList = []; // 用于顺序播放时，每个词对应其课文名
    let lessonNameArr = []; // 选中范围课文名列表
    let wordsFlatArr = []; // 选中范围内的完整顺序词语数组
    function buildWordToLessonMapForCurrentRange() {
        // 用于顺序朗读时，为每个词记录课文名
        wordToLessonNameList = [];
        lessonNameArr = [];
        wordsFlatArr = [];
        const startIdx = Number(startLessonSel.value);
        const endIdx = Number(endLessonSel.value);
        for (let i = startIdx; i <= endIdx; i++) {
            const lesson = LESSONS[i];
            // 对当前课的每个词标记课名
            for (let j = 0; j < lesson.words.length; j++) {
                wordToLessonNameList.push(lesson.name);
                wordsFlatArr.push(lesson.words[j]);
            }
            lessonNameArr.push(lesson.name);
        }
    }
    // ===============================

    function updateShuffle() {
        shuffleCb.checked = shuffleRadio.checked;
    }
    shuffleRadio.addEventListener('change', function() {
        updateShuffle();
    });
    orderRadio.addEventListener('change', function() {
        updateShuffle();
    });
    updateShuffle();

    function updateAutoNext() {
        autoNextCb.checked = autoRadio.checked;
        intervalEarly.disabled = !autoRadio.checked;
        if (autoRadio.checked) {
            intervalSetting.classList.remove('hide');
        } else {
            intervalSetting.classList.add('hide');
        }
    }
    autoRadio.addEventListener('change', function(){
        updateAutoNext();
        if(playing && !paused) {
            if (timer) {
                clearTimeout(timer);
                timer = null;  // 添加这一行
            }
            if(autoNextCb.checked) {
                timer = setTimeout(function autoGo(){
                    if (speaking || paused || !playing) {  // 增加 !playing 检查
                        setTimeout(autoGo, 100);
                        return;
                    }
                    nextWord(true);
                }, Number(intervalInput.value)*1000);
            }
        }
    });

    manualRadio.addEventListener('change', function(){
        updateAutoNext();
        if(playing && !paused) {
            if (timer) {
                clearTimeout(timer);
                timer = null;  // 添加这一行
            }
            if(autoNextCb.checked) {
                timer = setTimeout(function autoGo(){
                    if (speaking || paused || !playing) {  // 增加 !playing 检查
                        setTimeout(autoGo, 100);
                        return;
                    }
                    nextWord(true);
                }, Number(intervalInput.value)*1000);
            }
        }
    });
    updateAutoNext();

    intervalEarly.addEventListener('input', function() {
        intervalInput.value = intervalEarly.value;
        if(playing && !paused && autoNextCb.checked) {
            if (timer) {
                clearTimeout(timer);
                timer = null;  // 添加这一行
            }
            timer = setTimeout(function autoGo(){
                if (speaking || paused || !playing) {  // 增加 !playing 检查
                    setTimeout(autoGo, 100);
                    return;
                }
                nextWord(true);
            }, Number(intervalInput.value)*1000);
        }
    });
    repeatCountEarly.addEventListener('input', function() {
        repeatCountInput.value = repeatCountEarly.value;
        if(playing && !paused && orderedList.length > 0){
            if (speechSynthesis.speaking) {
                try { speechSynthesis.cancel(); }catch(e){}
            }
            playCurrentWordWithRepeat(function() {
                if (autoNextCb.checked && playing && !paused && orderedList.length > 0 && currentIndex < orderedList.length - 1) {
                    if (timer) clearTimeout(timer);
                    timer = setTimeout(function autoGo(){
                        if (speaking || paused) {
                            setTimeout(autoGo, 100);
                            return;
                        }
                        nextWord(true);
                    }, Number(intervalInput.value)*1000);
                }
            });
        }
    });
    rateEarly.addEventListener('input', function() {
        // 只允许整数1-3
        let intVal = parseInt(rateEarly.value) || 1;
        if (intVal < 1) intVal = 1;
        if (intVal > 3) intVal = 3;
        rateEarly.value = intVal;
        rateInput.value = rateEarly.value;
        if(playing && !paused && orderedList.length > 0){
            if (speechSynthesis.speaking) {
                try { speechSynthesis.cancel(); }catch(e){}
            }
            playCurrentWordWithRepeat(function() {
                if (autoNextCb.checked && playing && !paused && orderedList.length > 0 && currentIndex < orderedList.length - 1) {
                    if (timer) clearTimeout(timer);
                    timer = setTimeout(function autoGo(){
                        if (speaking || paused) {
                            setTimeout(autoGo, 100);
                            return;
                        }
                        nextWord(true);
                    }, Number(intervalInput.value)*1000);
                }
            });
        }
    });
    intervalInput.value = intervalEarly.value;
    intervalInput.disabled = intervalEarly.disabled;
    repeatCountInput.value = repeatCountEarly.value;
    rateInput.value = rateEarly.value;

    function populateLessonSelects() {
        startLessonSel.innerHTML = "";
        endLessonSel.innerHTML = "";
        for (let i = 0; i < LESSONS.length; i++) {
            const opt1 = document.createElement("option");
            const opt2 = document.createElement("option");
            opt1.value = i;
            opt2.value = i;
            opt1.textContent = LESSONS[i].name;
            opt2.textContent = LESSONS[i].name;
            startLessonSel.appendChild(opt1);
            endLessonSel.appendChild(opt2);
        }
        endLessonSel.selectedIndex = LESSONS.length - 1;
    }

    // 修改: 按课文分组返回对象 { 课文名字: [词语数组] }
    function getWordsGroupedByLessonRange(startIdx, endIdx) {
        if (startIdx > endIdx) return {};
        const res = {};
        for (let i = startIdx; i <= endIdx; i++) {
            res[LESSONS[i].name] = LESSONS[i].words.slice();
        }
        return res;
    }
    // 保留原有的数组构造，用于实际听写流程
    function getWordsByLessonRange(startIdx, endIdx) {
        if (startIdx > endIdx) return [];
        const res = [];
        for (let i = startIdx; i <= endIdx; i++) {
            res.push(...LESSONS[i].words);
        }
        return res;
    }
    function getWordsArrayFromInput() {
        let arr = wordsInput.value
            .replace(/[\r\n]+/g, ' ')
            .split(/[\s,，、]+/).map(w=>w.trim()).filter(w=>w.length);
        return arr;
    }

    // 按课文分块展示词语预览
    function showWordsPreview() {
        // 获取所选课文区间
        const startIdx = Number(startLessonSel.value);
        const endIdx = Number(endLessonSel.value);
        if (isNaN(startIdx) || isNaN(endIdx) || startIdx > endIdx) {
            wordsPreview.innerHTML = "<span style='color:#c44'>（当前无词语）</span>";
            wordsPreview.classList.remove("hide");
            return;
        }
        const grouped = getWordsGroupedByLessonRange(startIdx, endIdx);

        // 如果没有词语
        let hasWords = false;
        Object.values(grouped).forEach(arr => { if (arr.length) hasWords = true; });
        if (!hasWords) {
            wordsPreview.innerHTML = "<span style='color:#c44'>（当前无词语）</span>";
            wordsPreview.classList.remove("hide");
            return;
        }
        let html = '';
        let lessonIdx = 0;
        for (const [lessonName, wordArr] of Object.entries(grouped)) {
            html += `<div class="preview-lesson-title">${lessonName}</div>`;
            html += `<div class="preview-lesson-words">`;
            for (let i = 0; i < wordArr.length; i++) {
                let word = wordArr[i];
                let pinyins = getWordPinyin(word) || [];
                // 避免拼音未对齐出错
                let pinyinHTML = '<div class="pinyin-text" style="display:flex;gap:3px;">'
                    + word.split('').map((c,j) => `<span>${(pinyins[j]!==undefined?pinyins[j]:"")}</span>`).join('')
                    + '</div>';
                let ziHTML = `<div class="zi-text">${word}</div>`;
                html += `<span class="pinyin-item">${pinyinHTML}${ziHTML}</span>`;
            }
            html += "</div>";
            lessonIdx++;
        }
        wordsPreview.innerHTML = html;
        wordsPreview.classList.remove("hide");
    }

    function hideWordsPreview() {
        wordsPreview.classList.add("hide");
    }
    function updateWordsPreviewOnRangeChange() {
        syncWordsInput();
        showWordsPreview();
    }
    // 填充 textarea 词语（仍为打平行）
    function syncWordsInput() {
        const startIdx = Number(startLessonSel.value);
        const endIdx = Number(endLessonSel.value);
        const selectedWords = getWordsByLessonRange(startIdx, endIdx);
        wordsInput.value = selectedWords.join('\n');
    }
    function syncRangeSelection(e) {
        let startIdx = Number(startLessonSel.value);
        let endIdx = Number(endLessonSel.value);
        if (startIdx > endIdx) {
            if (e && e.target === startLessonSel) {
                endLessonSel.value = startLessonSel.value;
            } else {
                startLessonSel.value = endLessonSel.value;
            }
            [startIdx, endIdx] = [Math.min(startIdx, endIdx), Math.max(startIdx, endIdx)];
        }
        updateWordsPreviewOnRangeChange();
    }
    function shuffleArr(arr) {
        let a = arr.slice();
        for(let i=a.length-1;i>0;i--){
            const j = Math.floor(Math.random()*(i+1));
            [a[i],a[j]]=[a[j],a[i]];
        }
        return a;
    }
    function speak(text, opts, onend) {
        if (!('speechSynthesis' in window)) {
            alert("该浏览器不支持语音朗读(speechSynthesis)！");
            if (onend) onend();
            return;
        }
        if (speechSynthesis.speaking) {
            try { speechSynthesis.cancel(); } catch(e) {}
        }
        let msg = new window.SpeechSynthesisUtterance(text.trim());
        msg.lang = 'zh-CN';
        // 用整数rate，只能1-3三档，实际语速设置为(0.4,1,1.4) 分别对应 1,2,3 ，更符合实际
        let rateVal = 1;
        if (typeof opts?.rate === 'string' || typeof opts?.rate === 'number') {
            rateVal = Number(opts.rate);
        }
        if (rateVal < 1) rateVal = 1;
        if (rateVal > 3) rateVal = 3;
        // 1 => 0.4, 2 => 1, 3 => 1.4
        let realRate = 1;
        if (rateVal === 1) realRate = 0.4;
        else if (rateVal === 2) realRate = 1;
        else if (rateVal === 3) realRate = 1.4;
        msg.rate = realRate;
        speaking = true;
        msg.onend = function() {
            speaking = false;
            if (onend) onend();
        };
        msg.onerror = function() {
            speaking = false;
            if (onend) onend();
        };
        speechSynthesis.speak(msg);
    }
    function showStatus(idx, repeatN, totalWords, repeatMax) {
        if (!totalWords || idx < 0 || idx >= totalWords) {
            statusDiv.textContent = "";
            return;
        }
        statusDiv.textContent = `第 ${idx+1} / ${totalWords} 个  |  第 ${repeatN} / ${repeatMax} 次`;
    }


    // ========== 重写 playCurrentWordWithRepeat 函数 ==========
    function playCurrentWordWithRepeat(cb) {
        if (!orderedList.length || paused) {
            if (cb) cb();
            return;
        }
        let repeatMax = Number(repeatCountInput.value) || 1;
        currentRepeat = 1;

        // 新增变量：用于顺序朗读课名
        let pendingLessonName = null;
        let lessonNameToSpeak = null;

        // 仅顺序播放（shuffle=false）生效：
        if (!shuffleCb.checked) {
            // 确保最新的映射
            buildWordToLessonMapForCurrentRange();
            // 找到orderedList[currentIndex]在wordsFlatArr中的index
            let allIdx = wordsFlatArr.indexOf(orderedList[currentIndex]);
            if (allIdx !== -1 && wordToLessonNameList.length === wordsFlatArr.length && wordToLessonNameList.length > 0) {
                // 在当前顺序中，检测是否为每课第1个词
                // 只有在第0个 或 前一个词课名不同，则要朗读新的课名
                if (allIdx === 0 || wordToLessonNameList[allIdx] !== wordToLessonNameList[allIdx-1]) {
                    // 朗读课名，完毕后朗读词语
                    pendingLessonName = wordToLessonNameList[allIdx];
                }
            }
        }

        function actuallySpeakWord() {
            showStatus(currentIndex, currentRepeat, orderedList.length, repeatMax);
            let intRate = parseInt(rateInput.value) || 1;
            if (intRate < 1) intRate = 1;
            if (intRate > 3) intRate = 3;
            speak(orderedList[currentIndex], { rate: intRate }, function() {
                if (!playing) { 
                    if (cb) cb(); 
                    return; 
                }
                if (paused) return;
                if (currentRepeat < repeatMax) {
                    currentRepeat++;
                    setTimeout(actuallySpeakWord, 2000);
                } else {
                    currentRepeat = 1;
                    if (cb) cb();
                }
            });
        }

        if (pendingLessonName) {
            // 用和词语朗读同样的语速
            let intRate = parseInt(rateInput.value) || 1;
            if (intRate < 1) intRate = 1;
            if (intRate > 3) intRate = 3;
            speak(pendingLessonName, { rate: intRate }, function() {
                setTimeout(actuallySpeakWord, 200); // 课名+词之间稍做停顿
            });
        } else {
            actuallySpeakWord();
        }
    }
    // ========== END playCurrentWordWithRepeat 重写 ==========


    function nextWord(auto=false) {
        if (!orderedList.length || paused) return;
        currentIndex += 1;
        if (currentIndex >= orderedList.length) {
            currentIndex = orderedList.length-1;
            pausePlay(true);
            return;
        }
        playCurrentWordWithRepeat(function() {
            if (autoNextCb.checked && playing && !paused) {
                timer = setTimeout(function waitIfSpeaking(){
                    if (speaking || paused) {
                        setTimeout(waitIfSpeaking, 100);
                        return;
                    }
                    nextWord(true);
                }, Number(intervalInput.value)*1000);
            }
        });
    }
    function prevWord() {
        if (!orderedList.length || paused) return;
        if (currentIndex > 0) {
            currentIndex -= 1;
            currentRepeat = 1;
            playCurrentWordWithRepeat();
        } else {
            currentRepeat = 1;
            playCurrentWordWithRepeat();
        }
    }
    function pausePlay(forceStop = false) {
        if (timer) clearTimeout(timer);
        timer = null;
        if (forceStop) {
            playing = false;
            paused = false;
            stopped = true;
            startBtn.disabled = true;
            pauseContinueBtn.disabled = true;
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            resetBtn.style.display = '';
            pauseContinueBtn.textContent = "暂停";
            statusDiv.textContent += "｜已停止";
            try { speechSynthesis.cancel(); } catch(e) {}
            showWordsPreview();
            return;
        }
        if (!playing || paused) {
            return;
        }
        paused = true;
        pauseContinueBtn.textContent = "继续";
        pauseContinueBtn.disabled = false;
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        try { speechSynthesis.cancel(); } catch(e) {}
        statusDiv.textContent += "｜已暂停";
    }
    function continuePlay() {
        if (!paused) return;
        paused = false;
        pauseContinueBtn.textContent = "暂停";
        pauseContinueBtn.disabled = false;
        prevBtn.disabled = false;
        nextBtn.disabled = false;
        if (!playing || stopped) return;
        playCurrentWordWithRepeat(function() {
            if (autoNextCb.checked && playing && !paused) {
                if (timer) clearTimeout(timer);
                timer = setTimeout(function autoGo(){
                    if (speaking || paused) {
                        setTimeout(autoGo, 100);
                        return;
                    }
                    nextWord(true);
                }, Number(intervalInput.value)*1000);
            }
        });
        statusDiv.textContent = statusDiv.textContent.replace(/｜已暂停$/, "");
    }
    function resetAll(){
        stopped = false;
        playing = false;
        paused = false;
        timer = null;
        currentIndex = 0;
        words = [];
        orderedList = [];
        currentRepeat = 1;
        statusDiv.textContent = "";
        startBtn.disabled = false;
        pauseContinueBtn.disabled = true;
        pauseContinueBtn.textContent = "暂停";
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        resetBtn.style.display = 'none';
        populateLessonSelects();
        updateWordsPreviewOnRangeChange();
        updateShuffle();
        updateAutoNext();
        intervalInput.value = intervalEarly.value;
        intervalInput.disabled = intervalEarly.disabled;
        repeatCountInput.value = repeatCountEarly.value;
        rateInput.value = rateEarly.value;
        try{ speechSynthesis.cancel(); }catch(e){}
    }
    function startPlay() {
        // 在函数开头添加定时器清理
        if (timer) {
            clearTimeout(timer);
            timer = null;
        }
        if (stopped) return;
        updateShuffle();
        updateAutoNext();
        intervalInput.value = intervalEarly.value;
        intervalInput.disabled = intervalEarly.disabled;
        repeatCountInput.value = repeatCountEarly.value;
        rateInput.value = rateEarly.value;

        words = getWordsArrayFromInput();
        if (words.length === 0) {
            alert("请先选择课文范围，或填写词语！");
            return;
        }
        orderedList = shuffleCb.checked ? shuffleArr(words) : words.slice();
        currentIndex = 0;
        currentRepeat = 1;
        playing = true;
        paused = false;
        stopped = false;
        lastWordsArr = words.slice();
        lastShuffleChecked = shuffleCb.checked;
        lastAutoNextChecked = autoNextCb.checked;
        lastIntervalValue = intervalInput.value;
        lastRepeatCount = repeatCountInput.value;
        lastRate = rateInput.value;
        lastOrderedList = orderedList.slice();

        // 若顺序，更新映射
        if (!shuffleCb.checked) buildWordToLessonMapForCurrentRange();

        startBtn.disabled = true;
        pauseContinueBtn.disabled = false;
        pauseContinueBtn.textContent = "暂停";
        prevBtn.disabled = false;
        nextBtn.disabled = false;
        resetBtn.style.display = 'none';
        hideWordsPreview();
        statusDiv.textContent = "";
        playCurrentWordWithRepeat(function() {
            if (autoNextCb.checked && playing && !paused && orderedList.length > 0 && currentIndex < orderedList.length - 1) {
                if (timer) clearTimeout(timer);
                timer = setTimeout(function autoGo(){
                    if (speaking || paused) {
                        setTimeout(autoGo, 100);
                        return;
                    }
                    nextWord(true);
                }, Number(intervalInput.value)*1000);
            }
        });
    }
    function restartPlay() {
        // 在函数开头添加定时器清理
        if (timer) {
            clearTimeout(timer);
            timer = null;
        }
        if (!lastWordsArr.length) {
            alert("没有可重新听写的词语（请先点击“开始”完整听写一轮）");
            return;
        }
        updateShuffle();
        updateAutoNext();
        intervalInput.value = intervalEarly.value;
        intervalInput.disabled = intervalEarly.disabled;
        repeatCountInput.value = repeatCountEarly.value;
        rateInput.value = rateEarly.value;

        words = getWordsArrayFromInput();
        if (words.length === 0) {
            alert("请先选择课文范围，或填写词语！");
            return;
        }
        orderedList = shuffleCb.checked ? shuffleArr(words) : words.slice();
        currentIndex = 0;
        currentRepeat = 1;
        playing = true;
        paused = false;
        stopped = false;
        lastWordsArr = words.slice();
        lastShuffleChecked = shuffleCb.checked;
        lastAutoNextChecked = autoNextCb.checked;
        lastIntervalValue = intervalInput.value;
        lastRepeatCount = repeatCountInput.value;
        lastRate = rateInput.value;
        lastOrderedList = orderedList.slice();

        // 若顺序，更新映射
        if (!shuffleCb.checked) buildWordToLessonMapForCurrentRange();

        startBtn.disabled = true;
        pauseContinueBtn.disabled = false;
        pauseContinueBtn.textContent = "暂停";
        prevBtn.disabled = false;
        nextBtn.disabled = false;
        resetBtn.style.display = 'none';
        hideWordsPreview();
        statusDiv.textContent = "";
        playCurrentWordWithRepeat(function() {
            if (autoNextCb.checked && playing && !paused && orderedList.length > 0 && currentIndex < orderedList.length - 1) {
                if (timer) clearTimeout(timer);
                timer = setTimeout(function autoGo(){
                    if (speaking || paused) {
                        setTimeout(autoGo, 100);
                        return;
                    }
                    nextWord(true);
                }, Number(intervalInput.value)*1000);
            }
        });
    }

    startBtn.addEventListener('click', () => {
        if (!stopped && !playing) startPlay();
    });

    pauseContinueBtn.addEventListener('click', () => {
        if (!playing) return;
        if (!paused) {
            pausePlay();
        } else {
            continuePlay();
        }
    });

    resetBtn.addEventListener('click', () => {
        resetAll();
    });

    restartBtn.addEventListener('click', () => {
        restartPlay();
    });

    nextBtn.addEventListener('click', () => {
        if (!orderedList.length || paused) return;
        if (timer) clearTimeout(timer);  // 清除现有定时器
        timer = null;  // 添加这一行，确保定时器完全重置
        if (currentIndex < orderedList.length-1) {
            currentIndex++;
            currentRepeat = 1;
            playCurrentWordWithRepeat(function() {
                if (autoNextCb.checked && playing && !paused && currentIndex < orderedList.length - 1) {
                    if (timer) clearTimeout(timer);
                    timer = setTimeout(function autoGo(){
                        if (speaking || paused) {
                            setTimeout(autoGo, 100);
                            return;
                        }
                        nextWord(true);
                    }, Number(intervalInput.value)*1000);
                }
            });
        }
    });

    prevBtn.addEventListener('click', () => {
        if (!orderedList.length || paused) return;
        if (timer) clearTimeout(timer);
        prevWord();
    });

    startLessonSel.addEventListener('change', syncRangeSelection);
    endLessonSel.addEventListener('change', syncRangeSelection);

    populateLessonSelects();
    updateWordsPreviewOnRangeChange();

    wordsInput.addEventListener('input', function() {
        // 用户自定义编辑文本时，不使用分组，只用自动分词+打平方式。
        let arr = getWordsArrayFromInput();
        if(arr.length === 0) {
            wordsPreview.innerHTML = "<span style='color:#c44'>（当前无词语）</span>";
            wordsPreview.classList.remove("hide");
            return;
        }
        let html = '<div class="preview-lesson-title">自定义词语</div>';
        html += `<div class="preview-lesson-words">`;
        for (let i = 0; i < arr.length; i++) {
            let word = arr[i];
            let pinyins = getWordPinyin(word) || [];
            let pinyinHTML = '<div class="pinyin-text" style="display:flex;gap:3px;">'
                + word.split('').map((c,j) => `<span>${(pinyins[j]!==undefined?pinyins[j]:"")}</span>`).join('')
                + '</div>';
            let ziHTML = `<div class="zi-text">${word}</div>`;
            html += `<span class="pinyin-item">${pinyinHTML}${ziHTML}</span>`;
        }
        html += "</div>";
        wordsPreview.innerHTML = html;
        wordsPreview.classList.remove("hide");
    });

    document.addEventListener('keydown', function(e){
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            if(!stopped && !playing) startPlay();
        }
    });

    showWordsPreview();
    updateShuffle();
    updateAutoNext();
    intervalInput.value = intervalEarly.value;
    intervalInput.disabled = intervalEarly.disabled;
    repeatCountInput.value = repeatCountEarly.value;
    rateInput.value = rateEarly.value;
    updateAutoNext();
})();
</script>
