<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëã±ËØ≠ËØæÊú¨ÁÇπËØªÂ∫îÁî®</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #f5f6fa;
            font-family: "ÂæÆËΩØÈõÖÈªë", "Arial", sans-serif;
        }
        .container {
            max-width: 1100px;
            margin: 30px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
            padding: 24px 32px 16px 32px;
        }
        header {
            text-align: center;
            margin-bottom: 18px;
        }
        h1 {
            margin: 0;
            font-size: 2.2em;
            color: #2d3a4b;
        }
        .subtitle {
            color: #888;
            font-size: 1.1em;
            margin-top: 6px;
        }
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 32px;
        }
        .book-section {
            flex: 2 1 480px;
            min-width: 320px;
        }
        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: #eaeaea;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 6px rgba(0,0,0,0.06);
        }
        #bookCanvas {
            width: 100%;
            display: block;
            background: #eaeaea;
        }
        .highlight-area {
            position: absolute;
            border: 2px solid #27ae60;
            background: rgba(39, 174, 96, 0.18);
            pointer-events: none;
            display: none;
            border-radius: 4px;
            z-index: 2;
        }
        .highlight-area.red {
            border: 2px solid #e74c3c !important;
            background: rgba(231, 76, 60, 0.18) !important;
        }
        /* È°∂ÈÉ®ÁøªËØëÊù° */
        .translation-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            z-index: 1000;
            background: rgba(39, 174, 96, 0.95);
            color: #fff;
            font-size: 1.15em;
            text-align: center;
            padding: 10px 0 8px 0;
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: background 0.2s;
            min-height: 36px;
        }
        .translation-bar .en {
            display: block;
            font-size: 1.05em;
            font-weight: normal;
            color: #e0f7e9;
            margin-top: 2px;
        }
        /* Âè≥‰∏äËßíÈü≥È¢ëÊéßÂà∂Êù° */
        .audio-toolbar {
            position: fixed;
            top: 10px;
            right: 24px;
            z-index: 1100;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.92);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 6px 14px 6px 10px;
            user-select: none;
        }
        .audio-toolbar button {
            background: #27ae60;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 1.1em;
            padding: 5px 10px;
            cursor: pointer;
            transition: background 0.15s;
            outline: none;
        }
        .audio-toolbar button:active {
            background: #219150;
        }
        .audio-toolbar label {
            color: #2d3a4b;
            font-size: 1em;
            margin-right: 2px;
        }
        .audio-toolbar select {
            font-size: 1em;
            border-radius: 4px;
            border: 1px solid #27ae60;
            padding: 2px 6px;
            outline: none;
            margin-right: 2px;
        }
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
                gap: 18px;
            }
            .book-section, .info-section {
                min-width: 0;
            }
            .translation-bar {
                font-size: 1em;
                padding: 8px 0 6px 0;
            }
            .audio-toolbar {
                top: 54px;
                right: 8px;
                padding: 5px 7px 5px 7px;
            }
        }
        .info-section {
            display: none;
        }
        .page-controls, .audio-controls, .controls, .status {
            display: none !important;
        }
        footer {
            text-align: center;
            color: #aaa;
            font-size: 0.98em;
            margin-top: 30px;
        }
        body {
            padding-top: 54px; /* ÁïôÂá∫È°∂ÈÉ®ÁøªËØëÊù°Á©∫Èó¥ */
        }
        /* Êñ∞Â¢ûÔºöÂõæÁâáÈ¢ÑÂä†ËΩΩËøõÂ∫¶Êù°Ê†∑Âºè */
        #preloadProgressBar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0;
            height: 4px;
            background: #27ae60;
            z-index: 2000;
            transition: width 0.3s;
        }
        /* Êñ∞Â¢ûÔºöÂè≥‰∏ãËßíÂçïÂÖÉÂàáÊç¢ÊµÆÂä®ÊåâÈíÆÂíåÂºπÁ™óÊ†∑Âºè */
        .unit-fab {
            position: fixed;
            right: 24px;
            bottom: 24px;
            z-index: 1300;
            background: #27ae60;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 2em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .unit-fab:active {
            background: #219150;
        }
        .unit-popup {
            position: fixed;
            right: 32px;
            bottom: 90px;
            z-index: 1350;
            background: rgba(255,255,255,0.98);
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.13);
            min-width: 200px;
            max-width: 90vw;
            max-height: 60vh;
            overflow-y: auto;
            padding: 18px 16px 14px 16px;
            font-size: 1.08em;
            display: none;
            animation: fadeInUnitPopup 0.18s;
        }
        @keyframes fadeInUnitPopup {
            from { opacity: 0; transform: translateY(30px);}
            to { opacity: 1; transform: translateY(0);}
        }
        .unit-popup.open {
            display: block;
        }
        .unit-popup h3 {
            margin: 0 0 10px 0;
            font-size: 1.13em;
            color: #27ae60;
            text-align: left;
        }
        .unit-popup .unit-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .unit-popup .unit-list li {
            padding: 7px 8px;
            margin-bottom: 4px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.15s;
            color: #2d3a4b;
        }
        .unit-popup .unit-list li:hover {
            background: #eafaf1;
            color: #27ae60;
            font-weight: bold;
        }
        .unit-popup .unit-list li.active {
            background: #eafaf1;
            color: #27ae60;
            font-weight: bold;
        }
        .unit-popup .unit-list li.loading {
            background: #f6f6f6;
            color: #aaa;
            font-weight: normal;
            cursor: wait;
            position: relative;
        }
        .unit-popup .unit-list li.loading::after {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #27ae60;
            border-top: 2px solid #fff;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
        /* ‰∏ª‰ΩìÈ°µÈù¢Âä†ËΩΩ‰∏≠ÈÅÆÁΩ© */
        .main-loading-mask {
            position: fixed;
            left: 0; top: 0; right: 0; bottom: 0;
            z-index: 3000;
            background: rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25em;
            color: #27ae60;
            pointer-events: all;
            transition: opacity 0.2s;
        }
        .main-loading-mask .spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 4px solid #27ae60;
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin-right: 16px;
            vertical-align: middle;
        }
        @media (max-width: 600px) {
            .unit-fab {
                right: 12px;
                bottom: 12px;
                width: 48px;
                height: 48px;
                font-size: 1.5em;
            }
            .unit-popup {
                right: 8px;
                bottom: 68px;
                min-width: 120px;
                padding: 12px 6px 10px 10px;
                font-size: 1em;
            }
        }
    </style>
    <!-- SheetJS (XLSX) CDN -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div id="preloadProgressBar"></div>
    <div class="translation-bar" id="translationBar">
        <span id="translationText"></span>
        <!-- <span id="originalText" class="en"></span> -->
    </div>
    <!-- Âè≥‰∏äËßíÈü≥È¢ëÊéßÂà∂Êù° -->
    <div class="audio-toolbar" id="audioToolbar">
        <label for="repeatCountSelect" title="ÊØèÂè•ËØùÊí≠ÊîæÊ¨°Êï∞">ÊØèÂè•Êí≠Êîæ</label>
        <select id="repeatCountSelect" title="ÊØèÂè•ËØùÊí≠ÊîæÊ¨°Êï∞">
            <option value="1">1Ê¨°</option>
            <option value="2" selected>2Ê¨°</option>
            <option value="3">3Ê¨°</option>
        </select>
        <span>Ê¨°</span>
        <button id="playAllToggleBtn" title="Êí≠ÊîæÊï¥È°µ/ÊöÇÂÅú">‚ñ∂Ô∏è Êï¥È°µ</button>
    </div>
    <!-- Êñ∞Â¢ûÔºöÂè≥‰∏ãËßíÂçïÂÖÉÂàáÊç¢ÊµÆÂä®ÊåâÈíÆÂíåÂºπÁ™ó -->
    <button class="unit-fab" id="unitFabBtn" title="ÂàáÊç¢ÂçïÂÖÉ">üìñ</button>
    <div class="unit-popup" id="unitPopup">
        <h3>ÂçïÂÖÉÂàáÊç¢</h3>
        <ul class="unit-list" id="unitList"></ul>
    </div>
    <!-- ‰∏ª‰ΩìÈ°µÈù¢Âä†ËΩΩ‰∏≠ÈÅÆÁΩ© -->
    <div class="main-loading-mask" id="mainLoadingMask" style="display:none;">
        <span class="spinner"></span>
        <span id="mainLoadingText">Âä†ËΩΩ‰∏≠...</span>
    </div>
    <div class="container">
        <div class="main-content">
            <div class="book-section">
                <div class="canvas-container" id="canvasContainer">
                    <canvas id="bookCanvas" width="600" height="800"></canvas>
                    <div id="highlightArea" class="highlight-area"></div>
                </div>
            </div>
            <!-- info-sectionÂ∑≤ÈöêËóè -->
        </div>
    </div>
    <script>
        // Ê£ÄÊü•SheetJSÊòØÂê¶Âä†ËΩΩ
        if (typeof XLSX === "undefined") {
            alert("XLSXÂ∫ìÊú™Âä†ËΩΩÔºåÊó†Ê≥ïËß£ÊûêËØæÊú¨Êï∞ÊçÆ„ÄÇËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÂà∑Êñ∞È°µÈù¢„ÄÇ");
        }

        // Áªü‰∏ÄÁöÑËµÑÊ∫êÂü∫Á°ÄË∑ØÂæÑÂèòÈáè
        const BASE_RES_URL = "https://raw.githubusercontent.com/316045779/primary-school/main/SecondGrade";
        // Áªü‰∏ÄÁöÑ‰∏ãËΩΩÊñá‰ª∂Â§πË∑ØÂæÑ
        const DOWNLOADS_PATH = BASE_RES_URL + "/downloads/";

        let textbookData = [];

        // Êñ∞Â¢ûÔºöÂçïÂÖÉ‰ø°ÊÅØ
        let unitListData = []; // [{unitName, pageIndex, fullName}]
        let unitNameToPageIndex = {}; // {unitName: pageIndex}

        // ÂàóÂêç‰∏éÂ≠óÊÆµÁöÑÊò†Â∞ÑÔºàÊ†πÊçÆÂÆûÈôÖxlsË°®Â§¥‰øÆÊîπÔºâ
        const FIELD_MAP = {
            originImgUrl: "originImgUrl",
            originSoundUrl: "originSoundUrl",
            original: "original",
            translation: "translation",
            duration: "duration",
            coordinate_x: "coordinate_x",
            coordinate_y: "coordinate_y",
            coordinate_width: "coordinate_width",
            coordinate_height: "coordinate_height",
            pageNumber: "pageNumber"
        };

        // ËµÑÊ∫êÁºìÂ≠ò
        const imageCache = {};
        const audioCache = {};

        // Êñ∞Â¢ûÔºöÂàÜÊâπÈ¢ÑÂä†ËΩΩÁõ∏ÂÖ≥
        const PRELOAD_BATCH_SIZE = 5; // ÊØèÊ¨°È¢ÑÂä†ËΩΩ5È°µ
        let preloadPageSet = new Set(); // Â∑≤ÁªèÈ¢ÑÂä†ËΩΩËøáÁöÑÈ°µÁ†Å

        // Êñ∞Â¢ûÔºöÊØèÂè•Êí≠ÊîæÊ¨°Êï∞ÔºåÈªòËÆ§2
        let repeatCount = 2;

        // ‰∏ª‰ΩìÂä†ËΩΩÈÅÆÁΩ©ÊéßÂà∂
        function showMainLoading(text) {
            const mask = document.getElementById('mainLoadingMask');
            if (mask) {
                mask.style.display = 'flex';
                document.getElementById('mainLoadingText').textContent = text || 'Âä†ËΩΩ‰∏≠...';
            }
        }
        function hideMainLoading() {
            const mask = document.getElementById('mainLoadingMask');
            if (mask) mask.style.display = 'none';
        }

        // È¢ÑÂä†ËΩΩÂõæÁâáÂíåÈü≥È¢ëÔºàÂè™È¢ÑÂä†ËΩΩ‰º†ÂÖ•ÁöÑpagesÔºâ
        function preloadResources(pages, onProgress, onComplete) {
            let total = 0, loaded = 0;
            const imgUrls = [];
            const audioUrls = [];
            pages.forEach(page => {
                if (page.originImgUrl && !imageCache[page.originImgUrl]) {
                    imgUrls.push(page.originImgUrl);
                }
                if (page.areas) {
                    page.areas.forEach(area => {
                        if (area.originSoundUrl && !audioCache[area.originSoundUrl]) {
                            audioUrls.push(area.originSoundUrl);
                        }
                    });
                }
            });
            total = imgUrls.length + audioUrls.length;
            if (total === 0) {
                if (onProgress) onProgress(1);
                if (onComplete) onComplete();
                return;
            }
            let progress = 0;
            function updateProgress() {
                progress++;
                if (onProgress) onProgress(progress / total);
                if (progress === total && onComplete) onComplete();
            }
            // È¢ÑÂä†ËΩΩÂõæÁâá
            imgUrls.forEach(url => {
                const img = new window.Image();
                img.onload = () => {
                    imageCache[url] = img;
                    updateProgress();
                };
                img.onerror = () => {
                    imageCache[url] = null;
                    updateProgress();
                };
                img.src = url;
            });
            // È¢ÑÂä†ËΩΩÈü≥È¢ëÔºàÂè™ÂÅöÁºìÂ≠òÔºå‰∏çËá™Âä®Êí≠ÊîæÔºâ
            audioUrls.forEach(url => {
                const audio = new window.Audio();
                audio.preload = "auto";
                audio.oncanplaythrough = () => {
                    audioCache[url] = audio;
                    updateProgress();
                };
                audio.onerror = () => {
                    audioCache[url] = null;
                    updateProgress();
                };
                // ÂÖºÂÆπÈÉ®ÂàÜÊµèËßàÂô®‰∏çËß¶Âèëoncanplaythrough
                setTimeout(() => {
                    if (!audioCache[url]) updateProgress();
                }, 4000);
                audio.src = url;
            });
        }

        // ÈÄöËøáÁªôÂÆöÁöÑxls/xlsxÊñá‰ª∂URL‰∏ãËΩΩÂπ∂Ëß£ÊûêËØæÊú¨Êï∞ÊçÆ
        function fetchAndParseXLS(url) {
            showMainLoading('ËØæÊú¨Êï∞ÊçÆÂä†ËΩΩ‰∏≠...');
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('‰∏ãËΩΩÊñá‰ª∂Â§±Ë¥•');
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => {
                    if (typeof XLSX === "undefined") {
                        alert("XLSXÂ∫ìÊú™Âä†ËΩΩÔºåÊó†Ê≥ïËß£ÊûêËØæÊú¨Êï∞ÊçÆ„ÄÇ");
                        hideMainLoading();
                        return;
                    }
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
                    // Á¨¨‰∏ÄË°å‰∏∫Ë°®Â§¥Ôºå‰ªéÁ¨¨‰∫åË°åÂºÄÂßã
                    const header = json[0];
                    const rows = json.slice(1);

                    // ÊåâÈ°µÁ†ÅÂàÜÁªÑ
                    const pageMap = {};
                    rows.forEach(row => {
                        // Ë∑≥ËøáÁ©∫Ë°å
                        if (!row || row.length === 0) return;
                        // Ëé∑ÂèñÂêÑÂ≠óÊÆµ
                        const get = (col) => row[header.indexOf(FIELD_MAP[col])] ?? "";
                        const pageNumber = get("pageNumber");
                        if (!pageNumber) return;
                        if (!pageMap[pageNumber]) {
                            pageMap[pageNumber] = {
                                originImgUrl: DOWNLOADS_PATH + get("originImgUrl").split(/[\\/]/).pop(),
                                areas: [],
                                pageNumber: pageNumber
                            };
                        }
                        pageMap[pageNumber].areas.push({
                            coordinate_x: parseFloat(get("coordinate_x")) || 0,
                            coordinate_y: parseFloat(get("coordinate_y")) || 0,
                            coordinate_width: parseFloat(get("coordinate_width")) || 0,
                            coordinate_height: parseFloat(get("coordinate_height")) || 0,
                            originSoundUrl: DOWNLOADS_PATH + get("originSoundUrl").split(/[\\/]/).pop(),
                            original: get("original"),
                            translation: get("translation"),
                            duration: parseFloat(get("duration")) || undefined
                        });
                    });
                    // ËΩ¨‰∏∫Êï∞ÁªÑÂπ∂ÊéíÂ∫è
                    textbookData = Object.values(pageMap).sort((a, b) => a.pageNumber - b.pageNumber);

                    // Êñ∞Â¢ûÔºöÊèêÂèñÂçïÂÖÉ‰ø°ÊÅØ
                    extractUnitsFromTextbookData();

                    // Ê∏≤ÊüìÂçïÂÖÉÂºπÁ™ó
                    renderUnitPopup();

                    // È¢ÑÂä†ËΩΩÂâç5È°µËµÑÊ∫êÂπ∂ÊòæÁ§∫ËøõÂ∫¶Êù°
                    showPreloadProgressBar();
                    showMainLoading('ËØæÊú¨ËµÑÊ∫êÈ¢ÑÂä†ËΩΩ‰∏≠...');
                    const firstBatch = textbookData.slice(0, PRELOAD_BATCH_SIZE);
                    preloadResources(
                        firstBatch,
                        (progress) => {
                            updatePreloadProgressBar(progress);
                        },
                        () => {
                            hidePreloadProgressBar();
                            hideMainLoading();
                            // Ê†áËÆ∞Â∑≤È¢ÑÂä†ËΩΩ
                            for (let i = 0; i < firstBatch.length; i++) {
                                preloadPageSet.add(i);
                            }
                            // Âä†ËΩΩÁ¨¨‰∏ÄÈ°µ
                            loadPage(0);
                        }
                    );
                })
                .catch(err => {
                    hideMainLoading();
                    alert('ËØæÊú¨Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•: ' + err.message);
                });
        }

        // Êñ∞Â¢ûÔºöÊèêÂèñÂçïÂÖÉ‰ø°ÊÅØ
        function extractUnitsFromTextbookData() {
            unitListData = [];
            unitNameToPageIndex = {};
            // ÈÅçÂéÜÊØè‰∏ÄÈ°µÔºåÊâæÂá∫originalÂ≠óÊÆµÂåÖÂê´UnitÁöÑÂÜÖÂÆπ
            for (let i = 0; i < textbookData.length; i++) {
                const page = textbookData[i];
                if (page.areas && page.areas.length > 0) {
                    for (let area of page.areas) {
                        if (area.original && typeof area.original === "string" && /Unit\s*\d+/i.test(area.original)) {
                            // Âè™‰øùÁïôÁ¨¨‰∏Ä‰∏™UnitÂá∫Áé∞ÁöÑÈ°µÈù¢
                            const match = area.original.match(/Unit\s*\d+[A-Za-z]?/i);
                            if (match) {
                                const unitName = match[0].replace(/\s+/g, " ").trim();
                                if (!unitNameToPageIndex[unitName]) {
                                    unitListData.push({
                                        unitName,
                                        pageIndex: i,
                                        fullName: area.original // ‰øùÂ≠òÂÖ®Áß∞
                                    });
                                    unitNameToPageIndex[unitName] = i;
                                }
                            }
                        }
                    }
                }
            }
            // Â¶ÇÊûúÊúÄÂêé‰∏Ä‰∏™unitÊòØUnit 1Âπ∂‰∏îÊòØÂçïËØçË°®ÔºåÊîπÂêç‰∏∫Word list
            if (unitListData.length > 0) {
                let last = unitListData[unitListData.length - 1];
                // ‰ºòÂåñÔºöÂ¶ÇÊûúÊúÄÂêé‰∏Ä‰∏™ÂçïÂÖÉÂêçÂåÖÂê´"Unit 1"Ôºà‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜôÔºâÔºåÁõ¥Êé•ÊîπÂêç‰∏∫"Word list"
                if (last.unitName && last.unitName.toLowerCase().includes("unit 1")) {
                    last.unitName = "Word list";
                    last.fullName = "Word list";
                }
            }
        }

        // Êñ∞Â¢ûÔºöÊ∏≤ÊüìÂè≥‰∏ãËßíÂçïÂÖÉÂºπÁ™ó
        function renderUnitPopup() {
            const unitList = document.getElementById('unitList');
            unitList.innerHTML = '';
            unitListData.forEach((unit, idx) => {
                const li = document.createElement('li');
                li.textContent = unit.fullName || unit.unitName;
                li.dataset.pageIndex = unit.pageIndex;
                li.dataset.unitIdx = idx;
                li.onclick = function() {
                    setUnitLoading(idx);
                    loadPageWithLoading(unit.pageIndex, idx);
                    closeUnitPopup();
                };
                unitList.appendChild(li);
            });
            updateUnitPopupActive();
        }

        // Êñ∞Â¢ûÔºöÈ´ò‰∫ÆÂΩìÂâçÂçïÂÖÉÔºàÂè™È´ò‰∫ÆÂΩìÂâçÔºåÂÖ∂‰ªñ‰∏çÂä†activeÔºâ
        function updateUnitPopupActive() {
            const unitList = document.getElementById('unitList');
            if (!unitList) return;
            Array.from(unitList.children).forEach((li, idx) => {
                li.classList.remove('active');
                // Âè™È´ò‰∫ÆÂΩìÂâçÂçïÂÖÉ
                const pageIdx = parseInt(li.dataset.pageIndex, 10);
                let nextUnitIdx = unitListData.findIndex(u => u.pageIndex > currentPage);
                let thisUnitIdx = unitListData.findIndex(u => u.pageIndex == pageIdx);
                if (thisUnitIdx === -1) return;
                let isActive = false;
                if (nextUnitIdx === -1) {
                    // ÊúÄÂêé‰∏Ä‰∏™ÂçïÂÖÉ
                    if (currentPage >= pageIdx) isActive = true;
                } else {
                    if (currentPage >= pageIdx && currentPage < unitListData[nextUnitIdx].pageIndex) isActive = true;
                }
                if (isActive) {
                    li.classList.add('active');
                }
            });
        }

        // ÂçïÂÖÉÂä†ËΩΩ‰∏≠Ê†∑Âºè
        function setUnitLoading(idx) {
            const unitList = document.getElementById('unitList');
            Array.from(unitList.children).forEach((li, i) => {
                li.classList.remove('loading');
                li.style.pointerEvents = '';
            });
            if (typeof idx === 'number') {
                const li = unitList.children[idx];
                if (li) {
                    li.classList.add('loading');
                    li.style.pointerEvents = 'none';
                }
            }
            // ‰∏ª‰ΩìÈ°µÈù¢ÊòæÁ§∫Âä†ËΩΩ‰∏≠
            showMainLoading('ÂçïÂÖÉÂàáÊç¢‰∏≠...');
        }
        function clearUnitLoading() {
            const unitList = document.getElementById('unitList');
            Array.from(unitList.children).forEach((li) => {
                li.classList.remove('loading');
                li.style.pointerEvents = '';
            });
            hideMainLoading();
        }

        // ÂåÖË£ÖloadPageÔºåÂàáÊç¢ÂçïÂÖÉÊó∂Âä†loading
        function loadPageWithLoading(pageIndex, unitIdx) {
            setUnitLoading(unitIdx);
            ensurePreloadForPage(pageIndex, function() {
                loadPage(pageIndex);
                setTimeout(clearUnitLoading, 300); // Á®çÂæÆÂª∂ËøüÂéªÈô§loadingÔºåÈò≤Ê≠¢Èó™ÁÉÅ
            });
        }

        // Êñ∞Â¢ûÔºöÂè≥‰∏ãËßíÂºπÁ™óÂºÄÂÖ≥
        function openUnitPopup() {
            document.getElementById('unitPopup').classList.add('open');
        }
        function closeUnitPopup() {
            document.getElementById('unitPopup').classList.remove('open');
        }
        function toggleUnitPopup() {
            document.getElementById('unitPopup').classList.toggle('open');
        }

        // È°µÈù¢Âä†ËΩΩÂêéÔºåËá™Âä®ÊãâÂèñÊåáÂÆöURLÁöÑxls/xlsxÊñá‰ª∂
        document.addEventListener("DOMContentLoaded", function() {
            const XLS_URL = BASE_RES_URL + "/diandu.xlsx";
            fetchAndParseXLS(XLS_URL);

            // Âè≥‰∏ãËßíÊµÆÂä®ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('unitFabBtn').onclick = function(e) {
                e.stopPropagation();
                toggleUnitPopup();
            };
            // ÁÇπÂáªÂºπÁ™óÂ§ñÈÉ®ÂÖ≥Èó≠
            document.addEventListener('click', function(e) {
                const popup = document.getElementById('unitPopup');
                const fabBtn = document.getElementById('unitFabBtn');
                if (!popup.contains(e.target) && e.target !== fabBtn) {
                    closeUnitPopup();
                }
            });
            // Èò≤Ê≠¢ÂºπÁ™óÂÜÖÁÇπÂáªÂÜíÊ≥°ÂÖ≥Èó≠
            document.getElementById('unitPopup').addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });

        // È¢ÑÂä†ËΩΩËøõÂ∫¶Êù°Áõ∏ÂÖ≥
        function showPreloadProgressBar() {
            const bar = document.getElementById('preloadProgressBar');
            if (bar) {
                bar.style.width = '0';
                bar.style.display = 'block';
            }
        }
        function updatePreloadProgressBar(progress) {
            const bar = document.getElementById('preloadProgressBar');
            if (bar) {
                bar.style.width = (progress * 100) + '%';
            }
        }
        function hidePreloadProgressBar() {
            const bar = document.getElementById('preloadProgressBar');
            if (bar) {
                bar.style.width = '100%';
                setTimeout(() => {
                    bar.style.display = 'none';
                }, 500);
            }
        }

        // Â∫îÁî®Áä∂ÊÄÅ
        let currentPage = 0;
        let currentAudio = null;
        let canvas, ctx;
        let img = null;
        let highlightArea;

        // Êñ∞Â¢ûÔºöÊï¥È°µÊí≠ÊîæÁõ∏ÂÖ≥
        let playAllMode = false;
        let playAllIndex = 0;
        let playAllTimeout = null;
        let playAllPausedIndex = null; // Êñ∞Â¢ûÔºöÁî®‰∫éËÆ∞ÂΩïÊöÇÂÅúÊó∂ÁöÑindex

        // Êñ∞Â¢ûÔºöÊï¥È°µÊí≠ÊîæÊó∂ÊØèÂè•ÁöÑÂΩìÂâçÊí≠ÊîæÊ¨°Êï∞
        let playAllRepeatCurrent = 0;

        // Êñ∞Â¢ûÔºöÂΩìÂâçÊ≠£Âú®Êí≠ÊîæÁöÑÂå∫ÂüüÔºàÁî®‰∫éÁ∫¢Ëâ≤È´ò‰∫ÆÔºâ
        let currentPlayingArea = null;

        // Ëß¶Êë∏ÊªëÂä®Áõ∏ÂÖ≥
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        let touchMoved = false;
        const SWIPE_THRESHOLD = 60; // px

        function updatePlayAllToggleBtn() {
            const btn = document.getElementById('playAllToggleBtn');
            if (playAllMode) {
                btn.textContent = '‚è∏Ô∏è ÊöÇÂÅú';
                btn.title = 'ÊöÇÂÅúÊï¥È°µÊí≠Êîæ';
            } else {
                btn.textContent = '‚ñ∂Ô∏è Êï¥È°µ';
                btn.title = 'Êí≠ÊîæÊï¥È°µ';
            }
        }

        function setHighlightArea(area, color) {
            if (!highlightArea || !area) return;
            const aspectRatio = img && img.naturalWidth > 0 ? img.naturalHeight / img.naturalWidth : 1.33;
            const drawHeight = canvas.width * aspectRatio;
            const areaX = area.coordinate_x * canvas.width;
            const areaY = area.coordinate_y * drawHeight;
            const areaWidth = area.coordinate_width * canvas.width;
            const areaHeight = area.coordinate_height * drawHeight;
            highlightArea.style.display = 'block';
            highlightArea.style.left = `${areaX}px`;
            highlightArea.style.top = `${areaY}px`;
            highlightArea.style.width = `${areaWidth}px`;
            highlightArea.style.height = `${areaHeight}px`;
            if (color === 'red') {
                highlightArea.classList.add('red');
            } else {
                highlightArea.classList.remove('red');
            }
        }

        function hideHighlightArea() {
            if (highlightArea) {
                highlightArea.style.display = 'none';
                highlightArea.classList.remove('red');
            }
            currentPlayingArea = null;
        }

        function init() {
            canvas = document.getElementById('bookCanvas');
            ctx = canvas.getContext('2d');
            highlightArea = document.getElementById('highlightArea');

            // ‰∫ã‰ª∂ÁõëÂê¨
            canvas.addEventListener('click', handleCanvasClick);

            // Ëß¶Êë∏ÊªëÂä®ÁõëÂê¨
            const canvasContainer = document.getElementById('canvasContainer');
            canvasContainer.addEventListener('touchstart', handleTouchStart, {passive: true});
            canvasContainer.addEventListener('touchmove', handleTouchMove, {passive: true});
            canvasContainer.addEventListener('touchend', handleTouchEnd, {passive: true});

            // Èº†Ê†áÂ∑¶Âè≥ÊªëÂä®ÊîØÊåÅÔºàÊ°åÈù¢Á´ØÔºâ
            let mouseDown = false, mouseStartX = 0, mouseStartY = 0, mouseMoved = false;
            canvasContainer.addEventListener('mousedown', e => {
                mouseDown = true;
                mouseStartX = e.clientX;
                mouseStartY = e.clientY;
                mouseMoved = false;
            });
            canvasContainer.addEventListener('mousemove', e => {
                if (!mouseDown) return;
                mouseMoved = true;
            });
            canvasContainer.addEventListener('mouseup', e => {
                if (!mouseDown) return;
                mouseDown = false;
                const deltaX = e.clientX - mouseStartX;
                const deltaY = e.clientY - mouseStartY;
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > SWIPE_THRESHOLD) {
                    if (deltaX > 0) {
                        goToPrevPage();
                    } else {
                        goToNextPage();
                    }
                }
            });

            // Ë∞ÉÊï¥CanvasÂ§ßÂ∞è
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            // ÂêàÂπ∂Êï¥È°µ/ÊöÇÂÅúÊåâÈíÆ
            document.getElementById('playAllToggleBtn').addEventListener('click', function() {
                if (!playAllMode) {
                    playAllMode = true;
                    // Â¶ÇÊûú‰πãÂâçÊöÇÂÅúËøáÔºåÁªßÁª≠‰ªéÊöÇÂÅúÁöÑindexÊí≠Êîæ
                    if (playAllPausedIndex !== null) {
                        playAllIndex = playAllPausedIndex;
                    } else {
                        playAllIndex = 0;
                    }
                    playAllRepeatCurrent = 0;
                    updatePlayAllToggleBtn();
                    playAllAreas();
                } else {
                    // ÊöÇÂÅúÊï¥È°µÊí≠Êîæ
                    playAllMode = false;
                    // ËÆ∞ÂΩïÂΩìÂâçÊí≠ÊîæÁöÑindex
                    playAllPausedIndex = playAllIndex;
                    if (currentAudio) currentAudio.pause();
                    hideHighlightArea();
                    if (playAllTimeout) {
                        clearTimeout(playAllTimeout);
                        playAllTimeout = null;
                    }
                    updatePlayAllToggleBtn();
                }
            });

            // Êñ∞Â¢ûÔºöÁõëÂê¨Êí≠ÊîæÊ¨°Êï∞ÈÄâÊã©
            document.getElementById('repeatCountSelect').addEventListener('change', function() {
                repeatCount = parseInt(this.value, 10) || 2;
            });

            updatePlayAllToggleBtn();
        }

        function handleTouchStart(e) {
            if (e.touches.length === 1) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchEndX = touchStartX;
                touchEndY = touchStartY;
                touchMoved = false;
            }
        }
        function handleTouchMove(e) {
            if (e.touches.length === 1) {
                touchEndX = e.touches[0].clientX;
                touchEndY = e.touches[0].clientY;
                if (Math.abs(touchEndX - touchStartX) > 10 || Math.abs(touchEndY - touchStartY) > 10) {
                    touchMoved = true;
                }
            }
        }
        function handleTouchEnd(e) {
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            if (touchMoved && Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > SWIPE_THRESHOLD) {
                if (deltaX > 0) {
                    goToPrevPage();
                } else {
                    goToNextPage();
                }
            }
            touchStartX = 0;
            touchEndX = 0;
            touchStartY = 0;
            touchEndY = 0;
            touchMoved = false;
        }

        function resizeCanvas() {
            if (!canvas) return;
            const container = canvas.parentElement;
            canvas.width = container.clientWidth || 600;
            if (img && img.complete && img.naturalWidth > 0 && img.naturalHeight > 0) {
                const aspectRatio = img.naturalHeight / img.naturalWidth;
                canvas.height = Math.round(canvas.width * aspectRatio);
            } else {
                canvas.height = 800;
            }
            if (img && img.complete && img.naturalWidth > 0) {
                drawPage();
            }
        }

        // Êñ∞Â¢ûÔºöÂàÜÊâπÈ¢ÑÂä†ËΩΩÈÄªËæë
        function ensurePreloadForPage(pageIndex, callback) {
            // ËÆ°ÁÆóÊú¨È°µÂ±û‰∫éÂì™‰∏™ÊâπÊ¨°
            const batchStart = Math.floor(pageIndex / PRELOAD_BATCH_SIZE) * PRELOAD_BATCH_SIZE;
            const batchEnd = Math.min(batchStart + PRELOAD_BATCH_SIZE, textbookData.length);
            let needPreload = false;
            for (let i = batchStart; i < batchEnd; i++) {
                if (!preloadPageSet.has(i)) {
                    needPreload = true;
                    break;
                }
            }
            if (!needPreload) {
                if (callback) callback();
                return;
            }
            showPreloadProgressBar();
            showMainLoading('ËØæÊú¨ËµÑÊ∫êÈ¢ÑÂä†ËΩΩ‰∏≠...');
            const batchPages = textbookData.slice(batchStart, batchEnd);
            preloadResources(
                batchPages,
                (progress) => {
                    updatePreloadProgressBar(progress);
                },
                () => {
                    hidePreloadProgressBar();
                    hideMainLoading();
                    for (let i = batchStart; i < batchEnd; i++) {
                        preloadPageSet.add(i);
                    }
                    if (callback) callback();
                }
            );
        }

        function loadPage(pageIndex) {
            if (pageIndex < 0 || pageIndex >= textbookData.length) return;
            ensurePreloadForPage(pageIndex, function() {
                currentPage = pageIndex;
                const page = textbookData[pageIndex];

                // Êõ¥Êñ∞È°∂ÈÉ®ÁøªËØëÊù°
                if (page.areas && page.areas.length > 0) {
                    updateTranslationBar(page.areas[0].translation, page.areas[0].original);
                } else {
                    updateTranslationBar('', '');
                }

                // ‰ºòÂÖà‰ΩøÁî®ÁºìÂ≠òÂõæÁâá
                if (imageCache[page.originImgUrl]) {
                    img = imageCache[page.originImgUrl];
                    resizeCanvas();
                    drawPage();
                } else {
                    img = new window.Image();
                    img.onload = function() {
                        imageCache[page.originImgUrl] = img;
                        resizeCanvas();
                        drawPage();
                    };
                    img.onerror = function() {
                        if (ctx) {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.fillStyle = "#ccc";
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.fillStyle = "#e74c3c";
                            ctx.font = "24px sans-serif";
                            ctx.textAlign = "center";
                            ctx.fillText("ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•", canvas.width/2, canvas.height/2);
                        }
                    };
                    img.src = page.originImgUrl;
                }

                hideHighlightArea();
                stopAudio();

                playAllMode = false;
                playAllIndex = 0;
                playAllPausedIndex = null;
                playAllRepeatCurrent = 0;
                if (playAllTimeout) {
                    clearTimeout(playAllTimeout);
                    playAllTimeout = null;
                }
                updatePlayAllToggleBtn();

                // Êñ∞Â¢ûÔºöÈ´ò‰∫ÆÂΩìÂâçÂçïÂÖÉ
                updateUnitPopupActive();
            });
        }

        function updateTranslationBar(translation, original) {
            document.getElementById('translationText').textContent = translation || '';
        }

        function drawPage() {
            if (!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!img || !img.complete || img.naturalWidth === 0) {
                ctx.fillStyle = "#ccc";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = "#e74c3c";
                ctx.font = "24px sans-serif";
                ctx.textAlign = "center";
                ctx.fillText("ÂõæÁâáÊú™Âä†ËΩΩ", canvas.width/2, canvas.height/2);
                return;
            }
            const aspectRatio = img.naturalHeight / img.naturalWidth;
            const drawHeight = canvas.width * aspectRatio;
            canvas.height = drawHeight;
            ctx.drawImage(img, 0, 0, canvas.width, drawHeight);

            // ÂèØÈÄâÔºöÁªòÂà∂ÂèØÁÇπÂáªÂå∫ÂüüÔºàË∞ÉËØïÁî®Ôºâ
            const page = textbookData[currentPage];
            if (page && page.areas) {
                page.areas.forEach(area => {
                    ctx.save();
                    // Â¶ÇÊûúÊòØÂΩìÂâçÊ≠£Âú®Êí≠ÊîæÁöÑÂå∫ÂüüÔºåÁîªÁ∫¢Ëâ≤
                    if (currentPlayingArea && area === currentPlayingArea) {
                        ctx.strokeStyle = '#e74c3c';
                        ctx.lineWidth = 2.5;
                    } else {
                        ctx.strokeStyle = 'rgba(46, 204, 113, 0.7)';
                        ctx.lineWidth = 2;
                    }
                    ctx.strokeRect(
                        area.coordinate_x * canvas.width,
                        area.coordinate_y * drawHeight,
                        area.coordinate_width * canvas.width,
                        area.coordinate_height * drawHeight
                    );
                    ctx.restore();
                });
            }
        }

        function handleCanvasClick(e) {
            if (playAllMode) return;
            if (!canvas) return;
            let x, y;
            if (e.touches && e.touches.length > 0) {
                const rect = canvas.getBoundingClientRect();
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                const rect = canvas.getBoundingClientRect();
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }

            const page = textbookData[currentPage];
            if (!img || !img.complete || img.naturalWidth === 0) return;
            const aspectRatio = img.naturalHeight / img.naturalWidth;
            const drawHeight = canvas.width * aspectRatio;

            if (!page || !page.areas) return;
            let found = false;
            for (const area of page.areas) {
                const areaX = area.coordinate_x * canvas.width;
                const areaY = area.coordinate_y * drawHeight;
                const areaWidth = area.coordinate_width * canvas.width;
                const areaHeight = area.coordinate_height * drawHeight;

                if (x >= areaX && x <= areaX + areaWidth &&
                    y >= areaY && y <= areaY + areaHeight) {

                    setHighlightArea(area, 'red');
                    currentPlayingArea = area;
                    drawPage();

                    if (area.originSoundUrl && area.originSoundUrl.trim() !== "" && area.originSoundUrl.toLowerCase() !== "undefined") {
                        playAudioRepeat(area.originSoundUrl, repeatCount, function() {
                            hideHighlightArea();
                            drawPage();
                        }, area);
                    } else {
                        hideHighlightArea();
                        drawPage();
                    }

                    updateTranslationBar(area.translation, area.original);

                    found = true;
                    break;
                }
            }
            if (!found) {
                hideHighlightArea();
                drawPage();
            }
        }

        // ‰øÆÊîπplayAudioRepeatÔºåÊîØÊåÅÈ´ò‰∫ÆÁ∫¢Ëâ≤Âå∫Âüü
        function playAudioRepeat(url, times, onAllEnd, areaForHighlight) {
            stopAudio();
            if (!url || url.trim() === "" || url.toLowerCase() === "undefined") {
                if (typeof onAllEnd === "function") onAllEnd();
                return;
            }
            let count = 0;
            function playOnce() {
                if (audioCache[url]) {
                    currentAudio = audioCache[url].cloneNode();
                } else {
                    currentAudio = new Audio(url);
                }
                // È´ò‰∫ÆÁ∫¢Ëâ≤Âå∫Âüü
                if (areaForHighlight) {
                    setHighlightArea(areaForHighlight, 'red');
                    currentPlayingArea = areaForHighlight;
                    drawPage();
                }
                const playPromise = currentAudio.play();
                if (playPromise && typeof playPromise.then === "function") {
                    playPromise.catch(function(err){
                        hideHighlightArea();
                        drawPage();
                        if (typeof onAllEnd === "function") onAllEnd();
                    });
                }
                currentAudio.onended = function() {
                    count++;
                    if (count < times) {
                        playOnce();
                    } else {
                        hideHighlightArea();
                        drawPage();
                        if (typeof onAllEnd === "function") onAllEnd();
                    }
                };
                currentAudio.onerror = function() {
                    hideHighlightArea();
                    drawPage();
                    if (typeof onAllEnd === "function") onAllEnd();
                };
            }
            playOnce();
        }

        function playAudio(url) {
            playAudioRepeat(url, repeatCount, function() {
                hideHighlightArea();
                drawPage();
            });
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            hideHighlightArea();
            drawPage();
        }

        function playAllAreas() {
            const page = textbookData[currentPage];
            if (!page.areas || page.areas.length === 0) {
                playAllMode = false;
                playAllPausedIndex = null;
                updatePlayAllToggleBtn();
                return;
            }
            if (playAllIndex >= page.areas.length) {
                playAllMode = false;
                playAllIndex = 0;
                playAllPausedIndex = null;
                playAllRepeatCurrent = 0;
                hideHighlightArea();
                drawPage();
                updatePlayAllToggleBtn();
                return;
            }
            const area = page.areas[playAllIndex];

            setHighlightArea(area, 'red');
            currentPlayingArea = area;
            drawPage();

            updateTranslationBar(area.translation, area.original);

            stopAudio();
            if (!area.originSoundUrl || area.originSoundUrl.trim() === "" || area.originSoundUrl.toLowerCase() === "undefined") {
                playAllIndex++;
                playAllRepeatCurrent = 0;
                playAllTimeout = setTimeout(() => {
                    playAllAreas();
                }, 300);
                return;
            }

            playAllRepeatCurrent = 0;
            function playCurrentAreaRepeat() {
                if (!playAllMode) {
                    hideHighlightArea();
                    drawPage();
                    updatePlayAllToggleBtn();
                    playAllPausedIndex = playAllIndex;
                    return;
                }
                if (playAllRepeatCurrent < repeatCount) {
                    let audio;
                    if (audioCache[area.originSoundUrl]) {
                        audio = audioCache[area.originSoundUrl].cloneNode();
                    } else {
                        audio = new Audio(area.originSoundUrl);
                    }
                    currentAudio = audio;
                    setHighlightArea(area, 'red');
                    currentPlayingArea = area;
                    drawPage();
                    const playPromise = audio.play();
                    if (playPromise && typeof playPromise.then === "function") {
                        playPromise.catch(function(err){
                            hideHighlightArea();
                            drawPage();
                            playAllRepeatCurrent = repeatCount;
                            playAllIndex++;
                            if (playAllMode) {
                                playAllTimeout = setTimeout(() => {
                                    playAllAreas();
                                }, 300);
                            } else {
                                updatePlayAllToggleBtn();
                            }
                        });
                    }
                    audio.onended = function() {
                        playAllRepeatCurrent++;
                        playCurrentAreaRepeat();
                    };
                    audio.onerror = function() {
                        hideHighlightArea();
                        drawPage();
                        playAllRepeatCurrent = repeatCount;
                        playAllIndex++;
                        if (playAllMode) {
                            playAllTimeout = setTimeout(() => {
                                playAllAreas();
                            }, 300);
                        } else {
                            updatePlayAllToggleBtn();
                        }
                    };
                } else {
                    playAllIndex++;
                    playAllPausedIndex = playAllIndex;
                    playAllRepeatCurrent = 0;
                    hideHighlightArea();
                    drawPage();
                    playAllTimeout = setTimeout(() => {
                        playAllAreas();
                    }, 300);
                }
            }
            playCurrentAreaRepeat();
        }

        function goToPrevPage() {
            if (currentPage > 0) {
                loadPage(currentPage - 1);
            }
        }

        function goToNextPage() {
            if (currentPage < textbookData.length - 1) {
                loadPage(currentPage + 1);
            }
        }

        window.addEventListener('DOMContentLoaded', function() {
            init();
        });
    </script>
</body>
</html>